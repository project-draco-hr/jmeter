{
  initTemplate();
  JMeterContext context=getThreadContext();
  SampleResult previousResult=context.getPreviousResult();
  if (previousResult == null) {
    return;
  }
  log.debug("RegexExtractor processing result");
  JMeterVariables vars=context.getVariables();
  String refName=getRefName();
  int matchNumber=getMatchNumber();
  final String defaultValue=getDefaultValue();
  if (defaultValue.length() > 0) {
    vars.put(refName,defaultValue);
  }
  Perl5Matcher matcher=JMeterUtils.getMatcher();
  String inputString=useUrl() ? previousResult.getUrlAsString() : useHeaders() ? previousResult.getResponseHeaders() : useCode() ? previousResult.getResponseCode() : useMessage() ? previousResult.getResponseMessage() : useUnescapedBody() ? StringEscapeUtils.unescapeHtml(previousResult.getResponseDataAsString()) : previousResult.getResponseDataAsString();
  if (log.isDebugEnabled()) {
    log.debug("Input = " + inputString);
  }
  PatternMatcherInput input=new PatternMatcherInput(inputString);
  String regex=getRegex();
  if (log.isDebugEnabled()) {
    log.debug("Regex = " + regex);
  }
  try {
    Pattern pattern=JMeterUtils.getPatternCache().getPattern(regex,Perl5Compiler.READ_ONLY_MASK);
    List matches=new ArrayList();
    int x=0;
    boolean done=false;
    do {
      if (matcher.contains(input,pattern)) {
        log.debug("RegexExtractor: Match found!");
        matches.add(matcher.getMatch());
      }
 else {
        done=true;
      }
      x++;
    }
 while (x != matchNumber && !done);
    int prevCount=0;
    String prevString=vars.get(refName + REF_MATCH_NR);
    if (prevString != null) {
      vars.remove(refName + REF_MATCH_NR);
      try {
        prevCount=Integer.parseInt(prevString);
      }
 catch (      NumberFormatException e1) {
        log.warn("Could not parse " + prevString + " "+ e1);
      }
    }
    int matchCount=0;
    try {
      MatchResult match;
      if (matchNumber >= 0) {
        match=getCorrectMatch(matches,matchNumber);
        if (match != null) {
          vars.put(refName,generateResult(match));
          saveGroups(vars,refName,match);
        }
 else {
          removeGroups(vars,refName);
        }
      }
 else {
        removeGroups(vars,refName);
        matchCount=matches.size();
        vars.put(refName + REF_MATCH_NR,Integer.toString(matchCount));
        for (int i=1; i <= matchCount; i++) {
          match=getCorrectMatch(matches,i);
          if (match != null) {
            final String refName_n=new StringBuffer(refName).append(UNDERSCORE).append(i).toString();
            vars.put(refName_n,generateResult(match));
            saveGroups(vars,refName_n,match);
          }
        }
      }
      for (int i=matchCount + 1; i <= prevCount; i++) {
        final String refName_n=new StringBuffer(refName).append(UNDERSCORE).append(i).toString();
        vars.remove(refName_n);
        removeGroups(vars,refName_n);
      }
    }
 catch (    RuntimeException e) {
      log.warn("Error while generating result");
    }
  }
 catch (  MalformedCachePatternException e) {
    log.warn("Error in pattern: " + regex);
  }
}
