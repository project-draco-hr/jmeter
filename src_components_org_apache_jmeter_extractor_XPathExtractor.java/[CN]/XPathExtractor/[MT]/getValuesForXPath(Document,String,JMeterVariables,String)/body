{
  String val=null;
  XObject xObject=XPathAPI.eval(d,query);
  final int objectType=xObject.getType();
  if (objectType == XObject.CLASS_NODESET) {
    NodeList matches=xObject.nodelist();
    int length=matches.getLength();
    vars.put(concat(refName,MATCH_NR),String.valueOf(length));
    for (int i=0; i < length; i++) {
      Node match=matches.item(i);
      if (match instanceof Element) {
        if (getFragment()) {
          val=getValueForNode(match);
        }
 else {
          final Node firstChild=match.getFirstChild();
          if (firstChild != null) {
            val=firstChild.getNodeValue();
          }
 else {
            val=match.getNodeValue();
          }
        }
      }
 else {
        val=match.getNodeValue();
      }
      if (val != null) {
        if (i == 0) {
          vars.put(refName,val);
        }
        vars.put(concat(refName,String.valueOf(i + 1)),val);
      }
    }
    vars.remove(concat(refName,String.valueOf(length + 1)));
  }
 else   if (objectType == XObject.CLASS_NULL || objectType == XObject.CLASS_UNKNOWN || objectType == XObject.CLASS_UNRESOLVEDVARIABLE) {
    log.warn("Unexpected object type: " + xObject.getTypeString() + " returned for: "+ getXPathQuery());
  }
 else {
    val=xObject.toString();
    vars.put(concat(refName,MATCH_NR),"1");
    vars.put(refName,val);
    vars.put(concat(refName,"1"),val);
    vars.remove(concat(refName,"2"));
  }
}
