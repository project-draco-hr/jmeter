{
  log.info("Running the test!");
  running=true;
  JMeterContextService.startTest();
  try {
    PreCompiler compiler=new PreCompiler();
    test.traverse(compiler);
  }
 catch (  RuntimeException e) {
    log.error("Error occurred compiling the tree:",e);
    JMeterUtils.reportErrorToUser("Error occurred compiling the tree: - see log file");
    return;
  }
  SearchByClass<TestListener> testListeners=new SearchByClass<TestListener>(TestListener.class);
  test.traverse(testListeners);
  testListeners.getSearchResults().addAll(testList);
  testList.clear();
  testListenersSave=testListeners;
  if (!startListenersLater) {
    notifyTestListenersOfStart(testListeners);
  }
  test.traverse(new TurnElementsOn());
  if (startListenersLater) {
    notifyTestListenersOfStart(testListeners);
  }
  List<?> testLevelElements=new LinkedList<Object>(test.list(test.getArray()[0]));
  removeThreadGroups(testLevelElements);
  SearchByClass<SetupThreadGroup> setupSearcher=new SearchByClass<SetupThreadGroup>(SetupThreadGroup.class);
  SearchByClass<AbstractThreadGroup> searcher=new SearchByClass<AbstractThreadGroup>(AbstractThreadGroup.class);
  SearchByClass<PostThreadGroup> postSearcher=new SearchByClass<PostThreadGroup>(PostThreadGroup.class);
  test.traverse(setupSearcher);
  test.traverse(searcher);
  test.traverse(postSearcher);
  TestCompiler.initialize();
  Iterator<SetupThreadGroup> setupIter=setupSearcher.getSearchResults().iterator();
  Iterator<AbstractThreadGroup> iter=searcher.getSearchResults().iterator();
  Iterator<PostThreadGroup> postIter=postSearcher.getSearchResults().iterator();
  ListenerNotifier notifier=new ListenerNotifier();
  int groupCount=0;
  JMeterContextService.clearTotalThreads();
  if (setupIter.hasNext()) {
    log.info("Starting setup thread groups");
    while (running && setupIter.hasNext()) {
      AbstractThreadGroup group=setupIter.next();
      groupCount++;
      log.info("Starting Setup Thread: " + groupCount);
      String groupName=startThreadGroup(group,groupCount,setupSearcher,testLevelElements,notifier);
      if (serialized && setupIter.hasNext()) {
        log.info("Waiting for setup thread group: " + groupName + " to finish before starting next setup group");
        while (running && allThreads.size() > 0) {
          pause(1000);
        }
      }
    }
    log.info("Waiting for all setup thread groups To Exit");
    waitThreadsStopped();
    log.info("All Setup Threads have ended");
    groupCount=0;
    JMeterContextService.clearTotalThreads();
  }
  System.gc();
  JMeterContextService.getContext().setSamplingStarted(true);
  while (running && iter.hasNext()) {
    AbstractThreadGroup group=iter.next();
    if (group instanceof SetupThreadGroup)     continue;
    if (group instanceof PostThreadGroup)     continue;
    groupCount++;
    String groupName=startThreadGroup(group,groupCount,searcher,testLevelElements,notifier);
    if (serialized && iter.hasNext()) {
      log.info("Waiting for thread group: " + groupName + " to finish before starting next group");
      while (running && allThreads.size() > 0) {
        pause(1000);
      }
    }
  }
  if (groupCount == 0) {
    log.info("No enabled thread groups found");
  }
 else {
    if (running) {
      log.info("All threads have been started");
    }
 else {
      log.info("Test stopped - no more threads will be started");
    }
  }
  waitThreadsStopped();
  if (postIter.hasNext()) {
    groupCount=0;
    JMeterContextService.clearTotalThreads();
    log.info("Starting post thread groups");
    while (running && postIter.hasNext()) {
      AbstractThreadGroup group=postIter.next();
      groupCount++;
      log.info("Starting Post Thread: " + groupCount);
      String groupName=startThreadGroup(group,groupCount,postSearcher,testLevelElements,notifier);
      if (serialized && postIter.hasNext()) {
        log.info("Waiting for post thread group: " + groupName + " to finish before starting next post group");
        while (running && allThreads.size() > 0) {
          pause(1000);
        }
      }
    }
    waitThreadsStopped();
  }
  notifyTestListenersOfEnd(testListenersSave);
}
