{
  log.info("Running the test!");
  running=true;
  testList=new ArrayList();
  SearchByClass testPlan=new SearchByClass(TestPlan.class);
  getTestTree().traverse(testPlan);
  Object[] plan=testPlan.getSearchResults().toArray();
  if (plan.length == 0) {
    System.err.println("Could not find the TestPlan!");
    log.error("Could not find the TestPlan!");
    System.exit(1);
  }
  if (((TestPlan)plan[0]).isSerialized()) {
    serialized=true;
  }
  JMeterContextService.startTest();
  compileTree();
  testListeners=new SearchByClass(TestListener.class);
  getTestTree().traverse(testListeners);
  Collection col=testListeners.getSearchResults();
  col.addAll(testList);
  testList=null;
  notifyTestListenersOfStart();
  getTestTree().traverse(new TurnElementsOn());
  List testLevelElements=new LinkedList(getTestTree().list(getTestTree().getArray()[0]));
  removeThreadGroups(testLevelElements);
  SearchByClass searcher=new SearchByClass(ThreadGroup.class);
  setMode();
  getTestTree().traverse(searcher);
  TestCompiler.initialize();
  JMeterThread[] threads;
  Iterator iter=searcher.getSearchResults().iterator();
  System.gc();
  notifier=new ListenerNotifier();
  schcdule_run=true;
  JMeterContextService.getContext().setSamplingStarted(true);
  int groupCount=0;
  while (iter.hasNext()) {
    groupCount++;
    ThreadGroup group=(ThreadGroup)iter.next();
    int numThreads=group.getNumThreads();
    boolean onErrorStopTest=group.getOnErrorStopTest();
    boolean onErrorStopThread=group.getOnErrorStopThread();
    String groupName=group.getName();
    int rampUp=group.getRampUp();
    float perThreadDelay=((float)(rampUp * 1000) / (float)numThreads);
    threads=new JMeterThread[numThreads];
    log.info("Starting " + numThreads + " threads for group "+ groupName+ ". Ramp up = "+ rampUp+ ".");
    if (onErrorStopTest) {
      log.info("Test will stop on error");
    }
 else     if (onErrorStopThread) {
      log.info("Thread will stop on error");
    }
 else {
      log.info("Continue on error");
    }
    for (int i=0; running && i < threads.length; i++) {
      ListedHashTree threadGroupTree=(ListedHashTree)searcher.getSubTree(group);
      threadGroupTree.add(group,testLevelElements);
      threads[i]=new JMeterThread(cloneTree(threadGroupTree),this,notifier);
      threads[i].setThreadNum(i);
      threads[i].setInitialContext(JMeterContextService.getContext());
      threads[i].setInitialDelay((int)(perThreadDelay * (float)i));
      threads[i].setThreadName(groupName + (groupCount) + "-"+ (i + 1));
      scheduleThread(threads[i],group);
      threads[i].setEngine(this);
      threads[i].setOnErrorStopTest(onErrorStopTest);
      threads[i].setOnErrorStopThread(onErrorStopThread);
      Thread newThread=new Thread(threads[i]);
      newThread.setName(threads[i].getThreadName());
      allThreads.put(threads[i],newThread);
      if (serialized && !iter.hasNext() && i == threads.length - 1) {
        serialized=false;
      }
      newThread.start();
    }
    schcdule_run=false;
    if (serialized) {
      while (running && allThreads.size() > 0) {
        try {
          Thread.sleep(1000);
        }
 catch (        InterruptedException e) {
        }
      }
    }
  }
}
