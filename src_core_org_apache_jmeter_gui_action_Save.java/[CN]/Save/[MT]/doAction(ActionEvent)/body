{
  HashTree subTree=null;
  if (!commands.contains(e.getActionCommand())) {
    throw new IllegalUserActionException("Invalid user command:" + e.getActionCommand());
  }
  if (e.getActionCommand().equals(SAVE_AS)) {
    subTree=GuiPackage.getInstance().getCurrentSubTree();
  }
 else {
    subTree=GuiPackage.getInstance().getTreeModel().getTestPlan();
  }
  String updateFile=testPlanFile;
  if (!SAVE.equals(e.getActionCommand()) || testPlanFile == null) {
    JFileChooser chooser=FileDialoger.promptToSaveFile(GuiPackage.getInstance().getTreeListener().getCurrentNode().getName() + ".jmx");
    if (chooser == null) {
      return;
    }
    updateFile=chooser.getSelectedFile().getAbsolutePath();
    if (!e.getActionCommand().equals(SAVE_AS)) {
      setTestPlanFile(updateFile);
    }
  }
  ActionRouter.getInstance().doActionNow(new ActionEvent(subTree,e.getID(),CheckDirty.SUB_TREE_SAVED));
  try {
    convertSubTree(subTree);
  }
 catch (  Exception err) {
  }
  Writer writer=null;
  FileOutputStream ostream=null;
  try {
    if (JMeterUtils.getPropDefault("file_format","2.1").equals("2.0")) {
      ostream=new FileOutputStream(updateFile);
      OldSaveService.saveSubTree(subTree,ostream);
    }
 else {
      writer=new FileWriter(updateFile);
      SaveService.saveTree(subTree,writer);
    }
  }
 catch (  Throwable ex) {
    testPlanFile=null;
    log.error("",ex);
    throw new IllegalUserActionException("Couldn't save test plan to file: " + updateFile);
  }
 finally {
    closeWriter(writer);
    closeStream(ostream);
    if (testPlanFile != null) {
      GuiPackage.getInstance().getMainFrame().setTitle(JMeterUtils.getExtendedFrameTitle(testPlanFile));
    }
    GuiPackage.getInstance().getMainFrame().repaint();
  }
}
