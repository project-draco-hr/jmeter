{
synchronized (sampleStore) {
    String key=StatisticalSampleResult.getKey(e,KEY_ON_THREADNAME);
    StatisticalSampleResult statResult=sampleTable.get(key);
    if (statResult == null) {
      statResult=new StatisticalSampleResult(e.getResult(),KEY_ON_THREADNAME);
      sampleTable.put(key,statResult);
      sampleStore.add(new SampleEvent(statResult,e.getThreadGroup()));
    }
    statResult.add(e.getResult());
    sampleCount++;
    boolean sendNow=false;
    if (NUM_SAMPLES_THRESHOLD != -1) {
      if (sampleCount >= NUM_SAMPLES_THRESHOLD) {
        sendNow=true;
      }
    }
    long now=0;
    if (TIME_THRESHOLD_MS != -1) {
      now=System.currentTimeMillis();
      if (batchSendTime == -1) {
        this.batchSendTime=now + TIME_THRESHOLD_MS;
      }
      if (batchSendTime < now) {
        sendNow=true;
      }
    }
    if (sendNow) {
      try {
        if (log.isDebugEnabled()) {
          log.debug("Firing sample");
        }
        sendBatch();
        if (TIME_THRESHOLD_MS != -1) {
          this.batchSendTime=now + TIME_THRESHOLD_MS;
        }
      }
 catch (      RemoteException err) {
        log.warn("sampleOccurred",err);
      }
    }
  }
}
