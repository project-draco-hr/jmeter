{
  try {
    JMeterContextService.incrNumberOfThreads();
    threadContext=JMeterContextService.getContext();
    threadContext.setVariables(threadVars);
    threadContext.setThreadNum(getThreadNum());
    threadContext.getVariables().put(LAST_SAMPLE_OK,"true");
    threadContext.setThread(this);
    testTree.traverse(compiler);
    if (scheduler) {
      startScheduler();
    }
    rampUpDelay();
    log.info("Thread " + Thread.currentThread().getName() + " started");
    controller.initialize();
    controller.addIterationListener(new IterationListener());
    threadContext.setSamplingStarted(true);
    threadStarted();
    while (running) {
      Sampler sam;
      while (running && (sam=controller.next()) != null) {
        try {
          threadContext.setCurrentSampler(sam);
          SamplePackage pack=compiler.configureSampler(sam);
          threadContext.getVariables().putObject(PACKAGE_OBJECT,pack);
          delay(pack.getTimers());
          Sampler sampler=pack.getSampler();
          sampler.setThreadContext(threadContext);
          sampler.setThreadName(threadName);
          TestBeanHelper.prepare(sampler);
          SampleResult result=sampler.sample(null);
          if (result != null) {
            result.setThreadName(threadName);
            threadContext.setPreviousResult(result);
            runPostProcessors(pack.getPostProcessors());
            checkAssertions(pack.getAssertions(),result);
            notifyListeners(pack.getSampleListeners(),result);
            compiler.done(pack);
            if (result.isStopThread() || (!result.isSuccessful() && onErrorStopThread)) {
              stopThread();
            }
            if (result.isStopTest() || (!result.isSuccessful() && onErrorStopTest)) {
              stopTest();
            }
          }
          if (scheduler) {
            stopScheduler();
          }
        }
 catch (        JMeterStopTestException e) {
          log.info("Stopping Test: " + e.toString());
          stopTest();
        }
catch (        JMeterStopThreadException e) {
          log.info("Stopping Thread: " + e.toString());
          stopThread();
        }
catch (        Exception e) {
          log.error("",e);
        }
      }
      if (controller.isDone()) {
        running=false;
      }
    }
  }
 catch (  JMeterStopTestException e) {
    log.info("Stopping Test: " + e.toString());
    stopTest();
  }
catch (  JMeterStopThreadException e) {
    log.info("Stop Thread seen: " + e.toString());
  }
catch (  Exception e) {
    log.error("Test failed!",e);
  }
 finally {
    threadContext.clear();
    log.info("Thread " + threadName + " is done");
    monitor.threadFinished(this);
    threadFinished();
  }
}
