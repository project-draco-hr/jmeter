{
  JMeterContext threadContext=JMeterContextService.getContext();
  try {
    initRun(threadContext);
    while (running) {
      Sampler sam;
      while (running && (sam=controller.next()) != null) {
        process_sampler(sam,null,threadContext);
      }
      if (controller.isDone()) {
        running=false;
      }
    }
  }
 catch (  JMeterStopTestException e) {
    log.info("Stopping Test: " + e.toString());
    stopTest();
  }
catch (  JMeterStopThreadException e) {
    log.info("Stop Thread seen: " + e.toString());
  }
catch (  Exception e) {
    log.error("Test failed!",e);
  }
catch (  ThreadDeath e) {
    throw e;
  }
catch (  Error e) {
    log.error("Test failed!",e);
  }
 finally {
    threadContext.clear();
    log.info("Thread finished: " + threadName);
    monitor.threadFinished(this);
    threadFinished();
  }
}
