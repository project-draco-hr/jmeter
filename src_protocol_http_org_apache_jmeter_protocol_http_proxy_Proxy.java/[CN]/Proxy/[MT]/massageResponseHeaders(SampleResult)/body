{
  String headers=res.getResponseHeaders();
  String[] headerLines=headers.split(NEW_LINE,-1);
  int contentLengthIndex=-1;
  boolean fixContentLength=false;
  for (int i=0; i < headerLines.length; i++) {
    String line=headerLines[i];
    String[] parts=line.split(":\\s+",2);
    if (parts.length == 2) {
      if (HTTPSamplerBase.TRANSFER_ENCODING.equalsIgnoreCase(parts[0])) {
        headerLines[i]=null;
        continue;
      }
      if (HTTPSamplerBase.HEADER_CONTENT_ENCODING.equalsIgnoreCase(parts[0]) && HTTPSamplerBase.ENCODING_GZIP.equalsIgnoreCase(parts[1])) {
        headerLines[i]=null;
        fixContentLength=true;
        continue;
      }
      if (HTTPSamplerBase.HEADER_CONTENT_LENGTH.equalsIgnoreCase(parts[0])) {
        contentLengthIndex=i;
        continue;
      }
    }
  }
  if (fixContentLength && contentLengthIndex >= 0) {
    headerLines[contentLengthIndex]=HTTPSamplerBase.HEADER_CONTENT_LENGTH + ": " + res.getResponseData().length;
  }
  StringBuffer sb=new StringBuffer(headers.length());
  for (int i=0; i < headerLines.length; i++) {
    String line=headerLines[i];
    if (line != null) {
      sb.append(line).append(NEW_LINE);
    }
  }
  return sb.toString();
}
