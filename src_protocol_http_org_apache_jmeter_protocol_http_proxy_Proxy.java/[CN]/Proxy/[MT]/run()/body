{
  String httpSamplerName=HTTPSamplerFactory.DEFAULT_CLASSNAME;
  if (target.getSamplerTypeName() == ProxyControl.SAMPLER_TYPE_HTTP_SAMPLER) {
    httpSamplerName=HTTPSamplerFactory.HTTP_SAMPLER_JAVA;
  }
 else   if (target.getSamplerTypeName() == ProxyControl.SAMPLER_TYPE_HTTP_SAMPLER2) {
    httpSamplerName=HTTPSamplerFactory.HTTP_SAMPLER_APACHE;
  }
  HTTPSamplerBase sampler=HTTPSamplerFactory.newInstance(httpSamplerName);
  HttpRequestHdr request=new HttpRequestHdr(sampler);
  SampleResult result=null;
  HeaderManager headers=null;
  try {
    request.parse(new BufferedInputStream(clientSocket.getInputStream()));
    request.getSampler(pageEncodings,formEncodings);
    headers=request.getHeaderManager();
    sampler.setHeaderManager(headers);
    boolean forcedHTTP=false;
    if (httpsSpoof) {
      if (httpsSpoofMatch.length() > 0) {
        String url=request.getUrl();
        if (url.matches(httpsSpoofMatch)) {
          sampler.setProtocol(HTTPConstants.PROTOCOL_HTTPS);
          forcedHTTP=true;
        }
      }
 else {
        sampler.setProtocol(HTTPConstants.PROTOCOL_HTTPS);
        forcedHTTP=true;
      }
    }
    sampler.threadStarted();
    result=sampler.sample();
    if (forcedHTTP && SampleResult.TEXT.equals(result.getDataType())) {
      final String enc=result.getDataEncodingWithDefault();
      String noHttpsResult=new String(result.getResponseData(),enc);
      final String HTTPS_HOST="https://([^:/]+)(:" + HTTPConstants.DEFAULT_HTTPS_PORT_STRING + ")?";
      noHttpsResult=noHttpsResult.replaceAll(HTTPS_HOST,"http://$1");
      result.setResponseData(noHttpsResult.getBytes(enc));
    }
    String pageEncoding=addPageEncoding(result);
    addFormEncodings(result,pageEncoding);
    writeToClient(result,new BufferedOutputStream(clientSocket.getOutputStream()),forcedHTTP);
  }
 catch (  UnknownHostException uhe) {
    log.warn("Server Not Found.",uhe);
    writeErrorToClient(HttpReplyHdr.formServerNotFound());
    result=generateErrorResult(result,uhe);
  }
catch (  IllegalArgumentException e) {
    log.error("Not implemented (probably used https)",e);
    writeErrorToClient(HttpReplyHdr.formNotImplemented("Probably used https instead of http. " + "To record https requests, see " + "<a href=\"http://jakarta.apache.org/jmeter/usermanual/component_reference.html#HTTP_Proxy_Server\">HTTP Proxy Server documentation</a>"));
    result=generateErrorResult(result,e);
  }
catch (  Exception e) {
    log.error("Exception when processing sample",e);
    writeErrorToClient(HttpReplyHdr.formTimeout());
    result=generateErrorResult(result,e);
  }
 finally {
    if (log.isDebugEnabled()) {
      log.debug("Will deliver sample " + sampler.getName());
    }
    if (headers != null) {
      headers.removeHeaderNamed(HTTPConstants.HEADER_COOKIE);
      headers.removeHeaderNamed(HTTPConstants.HEADER_AUTHORIZATION);
      for (int i=0; i < headersToRemove.length; i++) {
        headers.removeHeaderNamed(headersToRemove[i]);
      }
    }
    target.deliverSampler(sampler,new TestElement[]{captureHttpHeaders ? headers : null},result);
    try {
      clientSocket.close();
    }
 catch (    Exception e) {
      log.error("",e);
    }
    sampler.threadFinished();
  }
}
