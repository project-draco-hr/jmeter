{
  HttpRequestHdr request=new HttpRequestHdr();
  byte[] serverResponse=new byte[0];
  HeaderManager headers=null;
  HTTPSampler sampler=new HTTPSampler();
  try {
    byte[] clientRequest=request.parse(new BufferedInputStream(clientSocket.getInputStream()));
    sampler=request.getSampler();
    if (captureHttpHeaders) {
      headers=request.getHeaderManager();
      sampler.setHeaderManager(headers);
    }
    serverResponse=sampler.sample().getResponseData();
    writeToClient(serverResponse,new BufferedOutputStream(clientSocket.getOutputStream()));
    if (captureHttpHeaders) {
      headers.removeHeaderNamed("cookie");
    }
  }
 catch (  UnknownHostException uhe) {
    log.warn("Server Not Found.",uhe);
    writeErrorToClient(HttpReplyHdr.formServerNotFound());
  }
catch (  Exception e) {
    log.error("",e);
    writeErrorToClient(HttpReplyHdr.formTimeout());
  }
 finally {
    target.deliverSampler(sampler,new TestElement[]{headers},serverResponse);
    try {
      clientSocket.close();
    }
 catch (    Exception e) {
      log.error("",e);
    }
  }
}
