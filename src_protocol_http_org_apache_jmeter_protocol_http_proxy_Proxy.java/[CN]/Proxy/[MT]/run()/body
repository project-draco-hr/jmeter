{
  HttpRequestHdr request=new HttpRequestHdr();
  SampleResult result=null;
  HeaderManager headers=null;
  HTTPSamplerBase sampler=null;
  try {
    request.parse(new BufferedInputStream(clientSocket.getInputStream()));
    sampler=request.getSampler();
    headers=request.getHeaderManager();
    sampler.setHeaderManager(headers);
    if (httpsSpoof) {
      sampler.setProtocol("https");
    }
    result=sampler.sample();
    if (httpsSpoof && SampleResult.TEXT.equals(result.getDataType())) {
      String noHttpsResult=new String(result.getResponseData());
      result.setResponseData(noHttpsResult.replaceAll("https","http").getBytes());
    }
    writeToClient(result,new BufferedOutputStream(clientSocket.getOutputStream()));
    headers.removeHeaderNamed("cookie");
  }
 catch (  UnknownHostException uhe) {
    log.warn("Server Not Found.",uhe);
    writeErrorToClient(HttpReplyHdr.formServerNotFound());
  }
catch (  Exception e) {
    log.error("",e);
    writeErrorToClient(HttpReplyHdr.formTimeout());
  }
 finally {
    if (sampler == null) {
      sampler=HTTPSamplerFactory.newInstance();
    }
    target.deliverSampler(sampler,new TestElement[]{captureHttpHeaders ? headers : null},result);
    try {
      clientSocket.close();
    }
 catch (    Exception e) {
      log.error("",e);
    }
  }
}
