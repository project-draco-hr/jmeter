{
  HttpURLConnection conn;
  HttpURLConnection.setFollowRedirects(getPropertyAsBoolean(AUTO_REDIRECTS));
  conn=(HttpURLConnection)u.openConnection();
  if ("https".equalsIgnoreCase(u.getProtocol())) {
    try {
      SSLManager.getInstance().setContext(conn);
    }
 catch (    Exception e) {
      log.warn("You may have forgotten to set the ssl.provider property " + "in jmeter.properties",e);
    }
  }
  if (getUseKeepAlive()) {
    conn.setRequestProperty("Connection","keep-alive");
  }
 else {
    conn.setRequestProperty("Connection","close");
  }
  conn.setRequestMethod(method);
  String hdrs=setConnectionHeaders(conn,u,getHeaderManager());
  String cookies=setConnectionCookie(conn,u,getCookieManager());
  if (res != null) {
    StringBuffer sb=new StringBuffer();
    if (method.equals(POST)) {
      String q=this.getQueryString();
      sb.append("\nQuery data:\n");
      sb.append(q);
      res.setQueryString(sb.toString());
    }
    if (cookies != null) {
      StringBuffer temp=new StringBuffer("\nCookie Data:\n");
      temp.append(cookies);
      temp.append('\n');
      res.setCookies(temp.toString());
      sb.append(temp);
    }
    res.setSamplerData(sb.toString());
    res.setURL(u);
    res.setHTTPMethod(method);
    res.setRequestHeaders(hdrs);
  }
  setConnectionAuthorization(conn,u,getAuthManager());
  if (method.equals(POST)) {
    setPostHeaders(conn);
  }
  return conn;
}
