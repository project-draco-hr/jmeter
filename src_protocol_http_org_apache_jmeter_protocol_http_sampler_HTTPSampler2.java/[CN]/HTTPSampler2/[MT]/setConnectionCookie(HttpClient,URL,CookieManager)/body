{
  StringBuffer cookieHeader=new StringBuffer(100);
  if (cookieManager != null) {
    String host="." + u.getHost();
    HttpState state=client.getState();
    for (int i=cookieManager.getCookies().size() - 1; i >= 0; i--) {
      Cookie cookie=(Cookie)cookieManager.getCookies().get(i).getObjectValue();
      if (cookie == null)       continue;
      long exp=cookie.getExpires();
      long now=System.currentTimeMillis() / 1000;
      String urlPath=u.getPath();
      if (log.isDebugEnabled()) {
        log.debug("Should we send cookie: " + cookie.toString());
        log.debug("Host=" + host + " Path="+ urlPath+ " Now="+ now);
      }
      String cookiePath=cookie.getPath();
      String cookieDomain=cookie.getDomain();
      if (host.endsWith(cookieDomain) && urlPath.startsWith(cookiePath) && (exp == 0 || exp > now)) {
        String cookieName=cookie.getName();
        String cookieValue=cookie.getValue();
        org.apache.commons.httpclient.Cookie newCookie=new org.apache.commons.httpclient.Cookie(cookieDomain,cookieName,cookieValue,cookiePath,null,false);
        state.addCookie(newCookie);
        cookieHeader.append(cookieName);
        cookieHeader.append("=");
        cookieHeader.append(cookieValue);
        if (log.isDebugEnabled()) {
          log.debug("Matched cookie");
        }
      }
 else {
        if (log.isDebugEnabled()) {
          log.debug("Did not match cookie.");
        }
      }
    }
  }
  return cookieHeader.toString();
}
