{
  String urlStr=u.toString();
  org.apache.commons.httpclient.URI uri=new org.apache.commons.httpclient.URI(urlStr,false);
  String schema=uri.getScheme();
  if ((schema == null) || (schema.length() == 0)) {
    schema=PROTOCOL_HTTP;
  }
  Protocol protocol=Protocol.getProtocol(schema);
  String host=uri.getHost();
  int port=uri.getPort();
  HostConfiguration hc=new HostConfiguration();
  hc.setHost(host,port,protocol);
  if (localAddress != null) {
    hc.setLocalAddress(localAddress);
  }
  boolean useProxy=PROXY_DEFINED && !isNonProxy(host);
  if (useProxy) {
    if (log.isDebugEnabled()) {
      log.debug("Setting proxy: " + PROXY_HOST + ":"+ PROXY_PORT);
    }
    hc.setProxy(PROXY_HOST,PROXY_PORT);
  }
  Map map=(Map)httpClients.get();
  HttpClient httpClient=(HttpClient)map.get(hc);
  if (httpClient == null) {
    httpClient=new HttpClient(new SimpleHttpConnectionManager());
    httpClient.setHostConfiguration(hc);
    map.put(hc,httpClient);
    if (useProxy) {
      if (PROXY_USER.length() > 0) {
        httpClient.getState().setProxyCredentials(new AuthScope(PROXY_HOST,PROXY_PORT,null,AuthScope.ANY_SCHEME),new UsernamePasswordCredentials(PROXY_USER,PROXY_PASS));
      }
    }
  }
  httpMethod.setFollowRedirects(getAutoRedirects());
  if (getUseKeepAlive()) {
    httpMethod.setRequestHeader(HEADER_CONNECTION,KEEP_ALIVE);
  }
 else {
    httpMethod.setRequestHeader(HEADER_CONNECTION,CONNECTION_CLOSE);
  }
  String hdrs=setConnectionHeaders(httpMethod,u,getHeaderManager());
  String cookies=setConnectionCookie(httpMethod,u,getCookieManager());
  if (res != null) {
    res.setURL(u);
    res.setRequestHeaders(hdrs);
    res.setCookies(cookies);
  }
  setConnectionAuthorization(httpClient,u,getAuthManager());
  return httpClient;
}
