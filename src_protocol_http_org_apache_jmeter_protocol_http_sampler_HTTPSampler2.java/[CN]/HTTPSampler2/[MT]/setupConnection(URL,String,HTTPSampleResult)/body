{
  String urlStr=u.toString();
  org.apache.commons.httpclient.URI uri=new org.apache.commons.httpclient.URI(urlStr);
  String schema=uri.getScheme();
  if ((schema == null) || (schema.equals(""))) {
    schema="http";
  }
  Protocol protocol=Protocol.getProtocol(schema);
  String host=uri.getHost();
  int port=uri.getPort();
  HostConfiguration hc=new HostConfiguration();
  hc.setHost(host,port,protocol);
  if (httpConn != null && hc.hostEquals(httpConn)) {
  }
 else {
    httpConn=new HttpConnection(hc);
    httpConn.setProxyHost(System.getProperty("http.proxyHost"));
    httpConn.setProxyPort(Integer.parseInt(System.getProperty("http.proxyPort","80")));
  }
  if (method.equals(HTTPSampler2.POST)) {
    httpMethod=new PostMethod(urlStr);
  }
 else {
    httpMethod=new GetMethod(urlStr);
    new DefaultMethodRetryHandler();
  }
  httpMethod.setHttp11(!System.getProperty("http.version","1.1").equals("1.0"));
  httpState=new HttpState();
  if (httpConn.isProxied() && httpConn.isSecure()) {
    httpMethod=new ConnectMethod(httpMethod);
  }
  httpMethod.setFollowRedirects(delegateRedirects && res.isRedirect());
  if (getUseKeepAlive()) {
    httpMethod.setRequestHeader("Connection","keep-alive");
  }
 else {
    httpMethod.setRequestHeader("Connection","close");
  }
  String hdrs=setConnectionHeaders(httpMethod,u,getHeaderManager());
  String cookies=setConnectionCookie(httpMethod,u,getCookieManager());
  if (res != null) {
    StringBuffer sb=new StringBuffer();
    if (method.equals(HTTPSampler.POST)) {
      String q=this.getQueryString();
      res.setQueryString(q);
      sb.append("Query data:\n");
      sb.append(q);
      sb.append('\n');
    }
    if (cookies != null) {
      res.setCookies(cookies);
      sb.append("\nCookie Data:\n");
      sb.append(cookies);
      sb.append('\n');
    }
    res.setSamplerData(sb.toString());
    res.setURL(u);
    res.setHTTPMethod(method);
    res.setRequestHeaders(hdrs);
  }
  setConnectionAuthorization(httpMethod,u,getAuthManager());
  if (method.equals(HTTPSampler2.POST)) {
    setPostHeaders((PostMethod)httpMethod);
  }
  return httpConn;
}
