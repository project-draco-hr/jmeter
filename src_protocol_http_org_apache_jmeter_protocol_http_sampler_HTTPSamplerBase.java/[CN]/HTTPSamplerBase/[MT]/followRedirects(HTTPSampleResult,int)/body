{
  HTTPSampleResult totalRes=new HTTPSampleResult(res);
  HTTPSampleResult lastRes=res;
  int redirect;
  for (redirect=0; redirect < MAX_REDIRECTS; redirect++) {
    boolean invalidRedirectUrl=false;
    String location=encodeSpaces(lastRes.getRedirectLocation());
    try {
      lastRes=sample(ConversionUtils.makeRelativeURL(lastRes.getURL(),location),GET,true,frameDepth);
    }
 catch (    MalformedURLException e) {
      lastRes=errorResult(e,lastRes);
      invalidRedirectUrl=true;
    }
    if (lastRes.getSubResults() != null && lastRes.getSubResults().length > 0) {
      SampleResult[] subs=lastRes.getSubResults();
      for (int i=0; i < subs.length; i++) {
        totalRes.addSubResult(subs[i]);
      }
    }
 else {
      if (!invalidRedirectUrl) {
        totalRes.addSubResult(lastRes);
      }
    }
    if (!lastRes.isRedirect()) {
      break;
    }
  }
  if (redirect >= MAX_REDIRECTS) {
    lastRes=errorResult(new IOException("Exceeeded maximum number of redirects: " + MAX_REDIRECTS),lastRes);
    totalRes.addSubResult(lastRes);
  }
  totalRes.setSampleLabel(totalRes.getSampleLabel() + "->" + lastRes.getSampleLabel());
  totalRes.setURL(lastRes.getURL());
  totalRes.setHTTPMethod(lastRes.getHTTPMethod());
  totalRes.setQueryString(lastRes.getQueryString());
  totalRes.setRequestHeaders(lastRes.getRequestHeaders());
  totalRes.setResponseData(lastRes.getResponseData());
  totalRes.setResponseCode(lastRes.getResponseCode());
  totalRes.setSuccessful(lastRes.isSuccessful());
  totalRes.setResponseMessage(lastRes.getResponseMessage());
  totalRes.setDataType(lastRes.getDataType());
  totalRes.setResponseHeaders(lastRes.getResponseHeaders());
  totalRes.setContentType(lastRes.getContentType());
  totalRes.setDataEncoding(lastRes.getDataEncodingNoDefault());
  return totalRes;
}
