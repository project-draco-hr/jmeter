{
  OutputStream w=null;
  try {
    byte[] readBuffer=new byte[8192];
    int bufferSize=32;
    MessageDigest md=null;
    boolean knownResponseLength=length > 0;
    if (useMD5()) {
      try {
        md=MessageDigest.getInstance("MD5");
      }
 catch (      NoSuchAlgorithmException e) {
        log.error("Should not happen - could not find MD5 digest",e);
      }
    }
 else {
      if (!knownResponseLength) {
        bufferSize=4 * 1024;
      }
 else {
        bufferSize=length;
      }
    }
    int bytesRead=0;
    int totalBytes=0;
    boolean first=true;
    while ((bytesRead=in.read(readBuffer)) > -1) {
      if (first) {
        sampleResult.latencyEnd();
        first=false;
        if (md == null) {
          if (knownResponseLength) {
            w=new DirectAccessByteArrayOutputStream(bufferSize);
          }
 else {
            w=new org.apache.commons.io.output.ByteArrayOutputStream(bufferSize);
          }
        }
      }
      if (md == null) {
        w.write(readBuffer,0,bytesRead);
      }
 else {
        md.update(readBuffer,0,bytesRead);
        totalBytes+=bytesRead;
      }
    }
    if (first) {
      sampleResult.latencyEnd();
      return new byte[0];
    }
    if (md != null) {
      byte[] md5Result=md.digest();
      sampleResult.setBytes(totalBytes);
      return JOrphanUtils.baToHexBytes(md5Result);
    }
    return toByteArray(w);
  }
  finally {
    IOUtils.closeQuietly(in);
    IOUtils.closeQuietly(w);
  }
}
