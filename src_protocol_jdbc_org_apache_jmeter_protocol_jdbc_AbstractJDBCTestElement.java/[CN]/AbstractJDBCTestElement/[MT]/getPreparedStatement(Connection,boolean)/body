{
  Map<String,PreparedStatement> preparedStatementMap=perConnCache.get(conn);
  if (null == preparedStatementMap) {
    preparedStatementMap=Collections.synchronizedMap(new LinkedHashMap<String,PreparedStatement>(MAX_ENTRIES){
      private static final long serialVersionUID=240L;
      @Override protected boolean removeEldestEntry(      Map.Entry<String,PreparedStatement> arg0){
        final int theSize=size();
        if (theSize > MAX_ENTRIES) {
          Object value=arg0.getValue();
          if (value instanceof PreparedStatement) {
            PreparedStatement pstmt=(PreparedStatement)value;
            close(pstmt);
          }
          return true;
        }
        return false;
      }
    }
);
    perConnCache.put(conn,preparedStatementMap);
  }
  PreparedStatement pstmt=preparedStatementMap.get(getQuery());
  if (null == pstmt) {
    if (callable) {
      pstmt=conn.prepareCall(getQuery());
    }
 else {
      pstmt=conn.prepareStatement(getQuery());
    }
    preparedStatementMap.put(getQuery(),pstmt);
  }
  pstmt.clearParameters();
  return pstmt;
}
