{
  ResourceLimitingJdbcDataSource source=null;
  source=new ResourceLimitingJdbcDataSource();
  DefaultConfiguration config=new DefaultConfiguration("rl-jdbc");
  if (log.isDebugEnabled()) {
    StringBuffer sb=new StringBuffer(40);
    sb.append("MaxPool: ");
    sb.append(maxPool);
    sb.append(" Timeout: ");
    sb.append(getTimeout());
    sb.append(" TrimInt: ");
    sb.append(getTrimInterval());
    sb.append(" Auto-Commit: ");
    sb.append(isAutocommit());
    log.debug(sb.toString());
  }
  DefaultConfiguration poolController=new DefaultConfiguration("pool-controller");
  poolController.setAttribute("max",maxPool);
  poolController.setAttribute("max-strict","true");
  poolController.setAttribute("blocking","true");
  poolController.setAttribute("timeout",getTimeout());
  poolController.setAttribute("trim-interval",getTrimInterval());
  config.addChild(poolController);
  DefaultConfiguration autoCommit=new DefaultConfiguration("auto-commit");
  autoCommit.setValue(String.valueOf(isAutocommit()));
  config.addChild(autoCommit);
  if (log.isDebugEnabled()) {
    StringBuffer sb=new StringBuffer(40);
    sb.append("KeepAlive: ");
    sb.append(isKeepAlive());
    sb.append(" Age: ");
    sb.append(getConnectionAge());
    sb.append(" CheckQuery: ");
    sb.append(getCheckQuery());
    log.debug(sb.toString());
  }
  DefaultConfiguration cfgKeepAlive=new DefaultConfiguration("keep-alive");
  cfgKeepAlive.setAttribute("disable",String.valueOf(!isKeepAlive()));
  cfgKeepAlive.setAttribute("age",getConnectionAge());
  cfgKeepAlive.setValue(getCheckQuery());
  poolController.addChild(cfgKeepAlive);
  String _username=getUsername();
  if (log.isDebugEnabled()) {
    StringBuffer sb=new StringBuffer(40);
    sb.append("Driver: ");
    sb.append(getDriver());
    sb.append(" DbUrl: ");
    sb.append(getDbUrl());
    sb.append(" User: ");
    sb.append(_username);
    log.debug(sb.toString());
  }
  DefaultConfiguration cfgDriver=new DefaultConfiguration("driver");
  cfgDriver.setValue(getDriver());
  config.addChild(cfgDriver);
  DefaultConfiguration cfgDbUrl=new DefaultConfiguration("dburl");
  cfgDbUrl.setValue(getDbUrl());
  config.addChild(cfgDbUrl);
  if (_username.length() > 0) {
    DefaultConfiguration cfgUsername=new DefaultConfiguration("user");
    cfgUsername.setValue(_username);
    config.addChild(cfgUsername);
    DefaultConfiguration cfgPassword=new DefaultConfiguration("password");
    cfgPassword.setValue(getPassword());
    config.addChild(cfgPassword);
  }
  source.enableLogging(new LogKitLogger(log));
  try {
    source.configure(config);
    source.setInstrumentableName(getDataSource());
  }
 catch (  ConfigurationException e) {
    log.error("Could not configure datasource for pool: " + getDataSource(),e);
  }
  return source;
}
