{
  Object objfac=null;
  try {
    objfac=ctx.lookup(factoryName);
  }
 catch (  NoClassDefFoundError e) {
    throw new NamingException("Lookup failed: " + e.toString());
  }
  if (objfac instanceof javax.jms.ConnectionFactory) {
    @SuppressWarnings("unchecked") Map<String,Object> env=(Map<String,Object>)ctx.getEnvironment();
    if (env.containsKey(Context.SECURITY_PRINCIPAL)) {
      String username=(String)env.get(Context.SECURITY_PRINCIPAL);
      String password=(String)env.get(Context.SECURITY_CREDENTIALS);
      return ((javax.jms.ConnectionFactory)objfac).createConnection(username,password);
    }
 else {
      return ((javax.jms.ConnectionFactory)objfac).createConnection();
    }
  }
  throw new NamingException("Expected javax.jms.ConnectionFactory, found " + objfac.getClass().getName());
}
