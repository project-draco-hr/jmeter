{
  String id=request.getJMSCorrelationID();
  if (id == null && !useReqMsgIdAsCorrelId) {
    log.error("Correlation id is null. Set the JMSCorrelationID header");
    return null;
  }
  if (useReqMsgIdAsCorrelId) {
    producer.send(request);
    id=request.getJMSMessageID();
    MessageAdmin.getAdmin().putRequest(id,request);
  }
 else {
    MessageAdmin.getAdmin().putRequest(id,request);
    producer.send(request);
  }
  try {
    if (log.isDebugEnabled()) {
      log.debug("wait for reply " + id + " started on "+ System.currentTimeMillis());
    }
synchronized (request) {
      request.wait(timeout);
    }
    if (log.isDebugEnabled()) {
      log.debug("done waiting for " + id + " ended on "+ System.currentTimeMillis());
    }
  }
 catch (  InterruptedException e) {
    log.warn("Interrupt exception caught",e);
  }
  return MessageAdmin.getAdmin().get(id);
}
