{
  String id=request.getJMSCorrelationID();
  if (id == null && !useReqMsgIdAsCorrelId) {
    log.error("Correlation id is null. Set the JMSCorrelationID header");
    return null;
  }
  final MessageAdmin admin=MessageAdmin.getAdmin();
  if (useReqMsgIdAsCorrelId) {
synchronized (admin) {
      producer.send(request);
      id=request.getJMSMessageID();
      admin.putRequest(id,request);
    }
  }
 else {
    admin.putRequest(id,request);
    producer.send(request);
  }
  try {
    if (log.isDebugEnabled()) {
      log.debug("wait for reply " + id + " started on "+ System.currentTimeMillis());
    }
synchronized (request) {
      request.wait(timeout);
    }
    if (log.isDebugEnabled()) {
      log.debug("done waiting for " + id + " ended on "+ System.currentTimeMillis());
    }
  }
 catch (  InterruptedException e) {
    log.warn("Interrupt exception caught",e);
  }
  return admin.get(id);
}
