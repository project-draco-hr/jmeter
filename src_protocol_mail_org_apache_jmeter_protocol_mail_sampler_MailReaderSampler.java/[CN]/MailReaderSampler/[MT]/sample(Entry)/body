{
  SampleResult parent=new SampleResult();
  boolean isOK=false;
  boolean deleteMessages=getDeleteMessages();
  parent.setSampleLabel(getName());
  String samplerString=toString();
  parent.setSamplerData(samplerString);
  parent.sampleStart();
  try {
    Properties props=new Properties();
    Session session=Session.getDefaultInstance(props,null);
    Store store=session.getStore(getServerType());
    store.connect(getServer(),getPortAsInt(),getUserName(),getPassword());
    Folder folder=store.getFolder(getFolder());
    if (deleteMessages) {
      folder.open(Folder.READ_WRITE);
    }
 else {
      folder.open(Folder.READ_ONLY);
    }
    Message messages[]=folder.getMessages();
    StringBuilder pdata=new StringBuilder();
    pdata.append(messages.length);
    pdata.append(" messages found\n");
    parent.setResponseData(pdata.toString(),null);
    parent.setDataType(SampleResult.TEXT);
    parent.setContentType("text/plain");
    int n=getNumMessages();
    if (n == ALL_MESSAGES || n > messages.length) {
      n=messages.length;
    }
    parent.setSampleCount(n);
    for (int i=0; i < n; i++) {
      StringBuilder cdata=new StringBuilder();
      SampleResult child=new SampleResult();
      child.sampleStart();
      Message message=messages[i];
      cdata.append("Message ");
      cdata.append(message.getMessageNumber());
      child.setSampleLabel(cdata.toString());
      child.setSamplerData(cdata.toString());
      cdata.setLength(0);
      final String contentType=message.getContentType();
      child.setContentType(contentType);
      if (isStoreMimeMessage()) {
        ByteArrayOutputStream bout=new ByteArrayOutputStream();
        message.writeTo(bout);
        child.setResponseData(bout.toByteArray());
        child.setDataType(SampleResult.TEXT);
        child.setDataEncoding("iso-8859-1");
        child.setEncodingAndType(contentType);
      }
 else {
        child.setEncodingAndType(contentType);
        @SuppressWarnings("unchecked") Enumeration<Header> hdrs=message.getAllHeaders();
        while (hdrs.hasMoreElements()) {
          Header hdr=hdrs.nextElement();
          String value=hdr.getValue();
          try {
            value=MimeUtility.decodeText(value);
          }
 catch (          UnsupportedEncodingException uce) {
          }
          cdata.append(hdr.getName()).append(": ").append(value).append("\n");
        }
        child.setResponseHeaders(cdata.toString());
        cdata.setLength(0);
        appendMessageData(child,message);
      }
      if (deleteMessages) {
        message.setFlag(Flags.Flag.DELETED,true);
      }
      child.setResponseOK();
      if (child.getEndTime() == 0) {
        child.sampleEnd();
      }
      parent.addSubResult(child);
    }
    folder.close(true);
    store.close();
    parent.setResponseCodeOK();
    parent.setResponseMessageOK();
    isOK=true;
  }
 catch (  NoClassDefFoundError ex) {
    log.debug("",ex);
    parent.setResponseCode("500");
    parent.setResponseMessage(ex.toString());
  }
catch (  MessagingException ex) {
    log.debug("",ex);
    parent.setResponseCode("500");
    parent.setResponseMessage(ex.toString());
  }
catch (  IOException ex) {
    log.debug("",ex);
    parent.setResponseCode("500");
    parent.setResponseMessage(ex.toString());
  }
  if (parent.getEndTime() == 0) {
    parent.sampleEnd();
  }
  parent.setSuccessful(isOK);
  return parent;
}
