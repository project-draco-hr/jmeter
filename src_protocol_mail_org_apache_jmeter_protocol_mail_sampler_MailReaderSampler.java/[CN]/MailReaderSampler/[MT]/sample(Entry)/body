{
  SampleResult res=new SampleResult();
  boolean isOK=false;
  String response=null;
  res.setSampleLabel(getTitle());
  res.sampleStart();
  try {
    Properties props=new Properties();
    Session session=Session.getDefaultInstance(props,null);
    Store store=session.getStore(getServerType());
    store.connect(getServer(),getUserName(),getPassword());
    Folder folder=store.getFolder(getFolder());
    folder.open(Folder.READ_WRITE);
    Message messages[]=folder.getMessages();
    Message message;
    StringBuffer data=new StringBuffer();
    data.append(messages.length + " new messages\n");
    int n=getNumMessages();
    if (n == -1 || n > messages.length)     n=messages.length;
    for (int i=0; i < n; i++) {
      message=messages[i];
      if (i == 0)       res.setContentType(message.getContentType());
      data.append("Message " + message.getMessageNumber() + ":\n");
      data.append("Date: " + message.getSentDate() + "\n");
      data.append("To: ");
      Address[] recips=message.getAllRecipients();
      for (int j=0; j < recips.length; j++) {
        data.append(recips[j].toString());
        if (j < recips.length - 1)         data.append("; ");
      }
      data.append("\n");
      data.append("From: ");
      Address[] from=message.getFrom();
      for (int j=0; j < from.length; j++) {
        data.append(from[j].toString());
        if (j < from.length - 1)         data.append("; ");
      }
      data.append("\n");
      data.append("Subject: " + message.getSubject() + "\n");
      data.append("\n" + message.getContent());
      if (getDeleteMessages()) {
        message.setFlag(Flags.Flag.DELETED,true);
      }
    }
    folder.close(true);
    store.close();
    response=Thread.currentThread().getName();
    res.setSamplerData(getServerType() + "://" + getUserName()+ "@"+ getServer());
    res.setResponseData(data.toString().getBytes());
    res.setDataType(SampleResult.TEXT);
    res.setResponseCode("200");
    res.setResponseMessage("OK");
    isOK=true;
  }
 catch (  Exception ex) {
    log.debug("",ex);
    res.setResponseCode("500");
    res.setResponseMessage(ex.toString());
  }
  res.sampleEnd();
  res.setSuccessful(isOK);
  return res;
}
