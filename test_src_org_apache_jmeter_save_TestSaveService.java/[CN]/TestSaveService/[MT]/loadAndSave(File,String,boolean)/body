{
  boolean failed=false;
  final FileStats origStats;
  try (FileReader fileReader=new FileReader(testFile);BufferedReader bufferedReader=new BufferedReader(fileReader)){
    origStats=computeFileStats(bufferedReader);
  }
   ByteArrayOutputStream out=new ByteArrayOutputStream(1000000);
  try {
    HashTree tree=SaveService.loadTree(testFile);
    SaveService.saveTree(tree,out);
  }
  finally {
    out.close();
  }
  final FileStats outputStats;
  try (ByteArrayInputStream ins=new ByteArrayInputStream(out.toByteArray());Reader insReader=new InputStreamReader(ins);BufferedReader bufferedReader=new BufferedReader(insReader)){
    outputStats=computeFileStats(bufferedReader);
  }
   if ((checkSize && !origStats.isSameSize(outputStats)) || !origStats.hasSameLinesCount(outputStats)) {
    failed=true;
    System.out.println();
    System.out.println("Loading file testfiles/" + fileName + " and "+ "saving it back changes its size from "+ origStats.size+ " to "+ outputStats.size+ ".");
    if (!origStats.hasSameLinesCount(outputStats)) {
      System.out.println("Number of lines changes from " + origStats.lines + " to "+ outputStats.lines);
    }
    if (saveOut) {
      final File outFile=findTestFile("testfiles/" + fileName + ".out");
      System.out.println("Write " + outFile);
      try (FileOutputStream outf=new FileOutputStream(outFile)){
        outf.write(out.toByteArray());
      }
       System.out.println("Wrote " + outFile);
    }
  }
  return failed;
}
