{
  boolean failed=false;
  final FileStats orig;
  try (FileReader fileReader=new FileReader(testFile);BufferedReader bufferedReader=new BufferedReader(fileReader)){
    orig=computeFileStats(bufferedReader);
  }
   ByteArrayOutputStream out=new ByteArrayOutputStream(1000000);
  try {
    HashTree tree=SaveService.loadTree(testFile);
    SaveService.saveTree(tree,out);
  }
  finally {
    out.close();
  }
  final FileStats output;
  try (ByteArrayInputStream ins=new ByteArrayInputStream(out.toByteArray());Reader insReader=new InputStreamReader(ins);BufferedReader bufferedReader=new BufferedReader(insReader)){
    output=computeFileStats(bufferedReader);
  }
   if ((checkSize && !orig.isSameSize(output)) || !orig.hasSameLinesCount(output)) {
    failed=true;
    System.out.println();
    System.out.println("Loading file testfiles/" + fileName + " and "+ "saving it back changes its size from "+ orig.size+ " to "+ output.size+ ".");
    if (!orig.hasSameLinesCount(output)) {
      System.out.println("Number of lines changes from " + orig.lines + " to "+ output.lines);
    }
    if (saveOut) {
      final File outFile=findTestFile("testfiles/" + fileName + ".out");
      System.out.println("Write " + outFile);
      FileOutputStream outf=null;
      try {
        outf=new FileOutputStream(outFile);
        outf.write(out.toByteArray());
      }
  finally {
        if (outf != null) {
          outf.close();
        }
      }
      System.out.println("Wrote " + outFile);
    }
  }
  return failed;
}
