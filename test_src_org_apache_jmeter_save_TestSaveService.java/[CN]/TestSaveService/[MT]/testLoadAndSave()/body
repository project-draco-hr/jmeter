{
  byte[] original=new byte[1000000];
  boolean failed=false;
  for (int i=0; i < FILES.length; i++) {
    InputStream in=new FileInputStream(findTestFile("testfiles/" + FILES[i]));
    int len=in.read(original);
    in.close();
    in=new ByteArrayInputStream(original,0,len);
    HashTree tree=SaveService.loadTree(in);
    in.close();
    ByteArrayOutputStream out=new ByteArrayOutputStream(1000000);
    SaveService.saveTree(tree,out);
    out.close();
    int outsz=out.size();
    int lines=0;
    byte ba[]=out.toByteArray();
    for (int j=0; j < ba.length; j++) {
      if (ba[j] == '\n') {
        lines++;
      }
    }
    if (len != outsz && len != outsz + lines) {
      failed=true;
      System.out.println();
      System.out.println("Loading file testfiles/" + FILES[i] + " and "+ "saving it back changes its size from "+ len+ " to "+ outsz+ ".");
      System.out.println("Diff " + (len - outsz) + " lines "+ lines);
      if (saveOut) {
        String outfile="testfiles/" + FILES[i] + ".out";
        System.out.println("Write " + outfile);
        FileOutputStream outf=new FileOutputStream(new File(outfile));
        outf.write(out.toByteArray());
        outf.close();
        System.out.println("Wrote " + outfile);
      }
    }
  }
  if (failed) {
    fail("One or more failures detected");
  }
}
